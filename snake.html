<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Snake: A quick-and-dirty proof of concept for $cent, the mini DOM manipulation library</title>
    <script type="text/javascript" src="./lib/cent.js"></script>
    <style>
    .game {
      width:800px;
      height: 80px;
    }

    .tile {
      height: 19px;
      width: 19px;
      background: gray;
      border-top: 1px solid white;
      border-left: 1px solid white;
      float: left;
    }

    .snake {
      background: green;
    }

    .food {
      background: red;
    }
    </style>
  </head>
  <body>
    <div class='game'>
    </div>
  </body>
  <script>
  let snake;
  let refreshInterval;
  let direction;
  let food;

  const snakeTile = function (row, col) {
    return $cent(`#r-${row}-c-${col}`).hasClass('snake');
  }

  const inBounds = function (row, col) {
    return row >= 0 && row < 40 && col >= 0 && col < 40;
  }

  const placeFood = function () {
    let foodRow = Math.floor(Math.random() * 39);
    let foodCol = Math.floor(Math.random() * 39);
    while (snakeTile(foodRow, foodCol)) {
      foodRow = Math.floor(Math.random() * 39);
      foodCol = Math.floor(Math.random() * 39);
    }
    food = `r-${foodRow}-c-${foodCol}`;
    $cent(`#${food}`).addClass('food');
  }

  const playRound = function () {
    const tail = snake.pop();
    const head = snake[0];
    const headLocation = head.split("-");
    let headRow = parseInt(headLocation[1]);
    let headCol = parseInt(headLocation[3]);
    $cent(`#${tail}`).removeClass('snake');

    switch (direction) {
      case 'up':
        headRow -= 1;
        break;
      case 'down':
        headRow += 1;
        break;
      case 'right':
        headCol += 1;
        break;
      case 'left':
        headCol -= 1;
        break;
    }

    if (snakeTile(headRow, headCol) || !inBounds(headRow, headCol)) {
      alert('You lose!');
      // initialize();
      return;
    }

    snake.unshift(`r-${headRow}-c-${headCol}`);
    $cent(`#${snake[0]}`).addClass('snake');

    if (snake[0] === food) {
      snake.push(tail);
      $cent(`#${tail}`).addClass('snake');
      $cent(`#${food}`).removeClass('food');
      placeFood();
    }

    // recursively play another round after refresh interval
    setTimeout(() => playRound(), refreshInterval);
  }

  const initialize = function () {
    snake = ['r-19-c-19', 'r-19-c-18', 'r-19-c-17', 'r-19-c-16', 'r-19-c-15'];
    food = "";
    refreshInterval = 200;
    direction = 'down';

    // add tiles to game board
    $cent('.game').html("");
    for (let row = 0; row < 40; row++) {
      for (let col = 0; col < 40; col++) {
        $cent('.game').append(`<div class='tile' id=r-${row}-c-${col}></div>`);
      }
    }

    // add snake to game board
    snake.forEach( (snakeTile, idx) => {
      $cent(`#${snake[idx]}`).addClass('snake');
    });

    placeFood();
    playRound();
  }

  $cent('body').on('keydown', (e) => {
    switch(e.keyCode) {
      case 37:
        direction = 'left';
        break;
      case 38:
        direction = 'up';
        break;
      case 39:
        direction = 'right';
        break;
      case 40:
        direction = 'down';
        break;
    }
  });

  initialize();
  </script>
</html>
